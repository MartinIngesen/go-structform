import:
  - unfold_templates.yml

data.numTypes: [
    uint, uint8, uint16, uint32, uint64,
    int, int8, int16, int32, int64,
    float32, float64
  ]

main: |
  package gotype

  import "github.com/urso/go-structform"

  {{/* define types */}}
  {{ template "makeType" "bool" }}
  {{ template "makeType" "string" }}
  {{ range .numTypes }}
    {{ template "makeType" . }}
  {{ end }}

  {{/* create visitor callbacks */}}
  {{ invoke "onBool" "name" "unfolderMapBool" "fn" "put" }}
  {{ invoke "onString" "name" "unfolderMapString" "fn" "put" }}
  {{ range .numTypes }}
    {{ $type := . }}
    {{ $name := capitalize $type | printf "unfolderMap%v" }}
    {{ invoke "onNumber" "name" $name "type" $type "fn" "put" }}
  {{ end }}

templates.makeType: |
  {{ $type := . }}
  {{ $name := capitalize $type | printf "unfolderMap%v" }}
  {{ $mapType := $type | printf "map[string]%v" }}

  {{ invoke "makeUnfoldType" "name" $name "type" $mapType }}

  func (u *{{ $name }} ) OnObjectStart(ctx *unfoldCtx, l int, baseType structform.BaseType) error {
    // TODO: validate baseType

    dtl := &ctx.detail
    if dtl.current != unfoldWaitStart {
      return errUnexpectedObjectStart
    }

    dtl.current = unfoldWaitKey
    return nil
  }

  func (u *{{ $name }} ) OnObjectFinished(ctx *unfoldCtx) error {
    dtl := &ctx.detail
    if dtl.current != unfoldWaitKey {
      return errExpectedObjectKey
    }

    u.free()

    dtl.pop()
    ctx.ptr.pop()
    ctx.unfolder.pop()
    return nil
  }

  func (u *{{ $name }} ) OnKey(ctx *unfoldCtx, key string) error {
    dtl := &ctx.detail

    if dtl.current != unfoldWaitKey {
      return errUnexpectedObjectKey
    }

    ctx.key.push(key)
    dtl.current = unfoldWaitElem
    return nil
  }

  func (u *{{ $name }} ) put(ctx *unfoldCtx, v {{ $type }}) error {
    dtl := &ctx.detail

    if dtl.current != unfoldWaitElem {
      return errExpectedObjectKey
    }

    to := (*map[string]{{ $type }})(ctx.ptr.current)

    if *to == nil {
      *to = map[string]{{ $type }}{}
    }
    (*to)[ctx.key.pop()] = v
    dtl.current = unfoldWaitKey
    return nil
  }
